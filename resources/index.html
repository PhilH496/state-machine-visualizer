<!DOCTYPE html>
<html>

<head>
    <title>State Machine Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/viz.js@2.1.2/viz.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/viz.js@2.1.2/full.render.js"></script>
    <style>
        body {
            max-width: 1200px;
            margin: auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            text-align: center;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .section {
            background-color: white;
            padding: 20px;
        }

        .section h2 {
            border-bottom: 2px solid #000000;
        }

        .error {
            color: #e74c3c;
            background-color: #ffe6e6;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e74c3c;
        }

        .file-input-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f4f8;
        }

        .file-input-container input[type="file"] {
            margin: 10px;
            padding: 8px;
        }

        #nfa,
        #dfa {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            background-color: #fafafa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            overflow: auto;
        }

        #nfa svg,
        #dfa svg {
            max-width: 100%;
            height: auto;
        }

        .graph-container {
            width: 100%;
            text-align: center;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h1>Regex to NFA/DFA Converter</h1>

    <div class="file-input-container" id="fileInputContainer">
        <p>Please select the <code>output.json</code> file to view results:</p>
        <input type="file" id="jsonFileInput" accept=".json" />
    </div>

    <div class="container">
        <div class="section">
            <h2>NFA (Non-deterministic Finite Automaton)</h2>
            <div class="graph-container">
                <div id="nfa">Loading...</div>
            </div>
        </div>

        <div class="section">
            <h2>DFA (Deterministic Finite Automaton)</h2>
            <div class="graph-container">
                <div id="dfa">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        function automatonToDOT(automaton) {
            const ensureArray = (value) => Array.isArray(value) ? value : [value];

            let dot = 'digraph G {\n';
            dot += '  rankdir=LR;\n';
            dot += '  node [shape=circle, style=filled, fillcolor=lightblue];\n';

            dot += `  start [shape=point, style=invis, width=0, height=0];\n`;
            dot += `  start -> "${automaton.start}";\n`;

            if (automaton.transitions) {
                for (const [srcState, stateTransitions] of Object.entries(automaton.transitions)) {
                    for (const [transitionSymbol, destStates] of Object.entries(stateTransitions)) {
                        for (const destinationState of ensureArray(destStates)) {
                            const escapedLabel = transitionSymbol.replace(/"/g, '\\"');
                            dot += `  "${srcState}" -> "${destinationState}" [label="${escapedLabel}"];\n`;
                        }
                    }
                }
            }

            for (const acceptState of automaton.accept) {
                dot += `  "${acceptState}" [fillcolor=gold];\n`;
            }

            dot += '}';
            return dot;
        }

        // Render automaton as SVG graph
        async function renderAutomaton(elementId, automaton) {
            const element = document.getElementById(elementId);
            try {
                const dot = automatonToDOT(automaton);

                const viz = new Viz();
                const result = await viz.renderString(dot);
                element.innerHTML = result;
                element.classList.remove('loading');
            } catch (error) {
                element.className = 'error';
                element.innerHTML = `<p>Error rendering graph: ${error.message}</p>`;
                console.error('Graph rendering error:', error);
                console.error('DOT string:', automatonToDOT(automaton));
            }
        }

        function displayData(data) {
            // Render NFA graph
            renderAutomaton('nfa', data.nfa);

            // Render DFA graph
            renderAutomaton('dfa', data.dfa);
        }

        async function loadResults() {
            try {
                const res = await fetch('./output.json');
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                displayData(data);
            } catch (error) {
                const fileInputContainer = document.getElementById('fileInputContainer');
                fileInputContainer.classList.remove('hidden');

                const nfaElement = document.getElementById('nfa');
                const dfaElement = document.getElementById('dfa');
                nfaElement.innerHTML = '<p style="text-align: center; ">Please select output.json file above to view results.</p>';
                dfaElement.innerHTML = '<p style="text-align: center; ">Please select output.json file above to view results.</p>';
                nfaElement.classList.remove('loading');
                dfaElement.classList.remove('loading');
            }
        }

        // Handle file input
        document.getElementById('jsonFileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        displayData(data);
                        // Hide file input after successful load
                        document.getElementById('fileInputContainer').classList.add('hidden');
                    } catch (error) {
                        const nfaElement = document.getElementById('nfa');
                        const dfaElement = document.getElementById('dfa');

                        nfaElement.className = 'error';
                        nfaElement.innerHTML = `<p>Error parsing JSON: ${error.message}</p>`;
                        dfaElement.className = 'error';
                        dfaElement.innerHTML = `<p>Error parsing JSON: ${error.message}</p>`;
                    }
                };
                reader.readAsText(file);
            }
        });
        loadResults();
    </script>
</body>

</html>